generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userid             String                @id @default(cuid())
  email              String                @unique @db.VarChar(255)
  password           String                @db.VarChar(255)
  role               String?               @default("USER") @db.VarChar(50)
  languagePreference String?               @default("zh-CN") @db.VarChar(50)
  createAt           DateTime              @default(now()) @db.Timestamptz(6)
  updateAt           DateTime              @updatedAt @db.Timestamptz(6)
  isOnline           Boolean               @default(false)
  lastActiveAt       DateTime?             @db.Timestamptz(6)
  isCommentAllowed   Boolean               @default(true)
  emailVerified      DateTime?             @db.Timestamptz(6)
  achievements       achievements[]
  comments           comments[]
  discussion_threads discussion_threads[]
  episode            episode[]
  episode_favorites  episode_favorites[]
  podcast_favorites  podcast_favorites[]
  learning_paths     learning_paths[]
  listening_history  listening_history[]
  notifications      notifications[]
  ratings            ratings[]
  speech_recognition speech_recognition[]
  study_groups       study_groups[]
  subscriptions      subscriptions[]
  user_profile       user_profile?
  vocabulary         vocabulary[]
  daily_activities   user_daily_activity[]
}

///用户资料模型，存储用户的个人信息
/// 
/// 该模型包含了用户的详细个人资料信息，如昵称、头像、个人简介等。
/// 通过 userid 与 User 模型建立一对一关系，实现用户基础信息与个人资料的分离。
/// 当用户被删除时，其个人资料也会被级联删除。
model user_profile {
  /// 用户ID，作为主键，与 User 模型的 userid 字段关联
  userid         String  @id
  /// 用户昵称，最大长度255个字符，可为空
  nickname       String? @db.VarChar(255)
  /// 用户头像URL地址，默认值为"default_avatar_url"，最大长度255个字符，可为空
  avatarUrl      String? @default("default_avatar_url") @db.VarChar(255)
  /// 头像文件名，用于本地存储时的文件标识，最大长度255个字符，可为空
  avatarFileName String? @db.VarChar(255)
  /// 用户个人简介或签名，可为空
  bio            String?
  /// 用户学习等级标识，最大长度50个字符，可为空
  learnLevel     String? @db.VarChar(50)
  /// 关联的用户基础信息，通过 userid 字段与 User 模型建立外键关系
  /// 删除策略为级联删除（当用户被删除时，个人资料也会被删除）
  /// 更新策略为无操作（当用户ID更新时，不执行任何操作）
  User           User    @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model achievements {
  achievementid   Int       @id @default(autoincrement())
  userid          String?
  achievementName String    @db.VarChar(255)
  achievementDate DateTime? @default(now()) @db.Timestamptz(6)
  User            User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model advertisements {
  adid      Int       @id @default(autoincrement())
  adTitle   String    @db.VarChar(255)
  adContent String?
  adUrl     String?   @db.VarChar(255)
  startAt   DateTime? @default(now()) @db.Timestamptz(6)
  endAt     DateTime? @db.Timestamptz(6)
}

model podcast {
  podcastid         String              @id @default(cuid())
  title             String              @unique @db.VarChar(255)
  coverUrl          String              @default("default_cover_url") @db.VarChar(255)
  coverFileName     String?             @db.VarChar(255)
  platform          String?             @db.VarChar(255)
  description       String?
  isEditorPick      Boolean?            @default(false)
  parentPodcastid   String?
  totalPlays        Int                 @default(0) // 总播放次数 (热度核心指标)
  followerCount     Int                 @default(0) // 收藏/订阅人数 (可选，用于展示)
  createAt          DateTime            @default(now()) @db.Timestamptz(6)
  podcast           podcast?            @relation("podcastTopodcast", fields: [parentPodcastid], references: [podcastid], onUpdate: NoAction)
  otherPodcast      podcast[]           @relation("podcastTopodcast")
  episode           episode[]
  podcast_favorites podcast_favorites[]
  tags              tag[]

  @@index([totalPlays(sort: Desc)]) // 加索引，查询 Top 50 极快
  // [新增] 建议为 createAt 添加索引以优化“最新”查询
  @@index([createAt(sort: Desc)])
}

model comments {
  commentid   Int       @id @default(autoincrement())
  userid      String?
  episodeid   String?
  commentText String?
  commentAt   DateTime? @default(now()) @db.Timestamptz(6)
  episode     episode?  @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
  User        User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model discussion_threads {
  threadid      Int       @id @default(autoincrement())
  episodeid     String?
  userid        String?
  threadTitle   String    @db.VarChar(255)
  threadContent String?
  postAt        DateTime? @default(now()) @db.Timestamptz(6)
  episode       episode?  @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
  User          User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model episode {
  episodeid          String               @id @default(cuid())
  title              String               @db.VarChar(255)
  coverUrl           String               @default("default_cover_url") @db.VarChar(255)
  coverFileName      String?              @db.VarChar(255)
  description        String?
  audioUrl           String               @db.VarChar(255)
  audioFileName      String?              @db.VarChar(255)
  subtitleEnUrl      String?              @db.VarChar(255)
  subtitleEnFileName String?              @db.VarChar(255)
  subtitleZhUrl      String?              @db.VarChar(255)
  subtitleZhFileName String?              @db.VarChar(255)
  duration           Int                  @default(0)
  playCount          Int                  @default(0) // 单集播放次数
  podcastid          String?
  uploaderid         String?
  publishAt          DateTime             @default(dbgenerated("CURRENT_DATE")) @db.Date
  createAt           DateTime?            @default(now()) @db.Timestamptz(6)
  updateAt           DateTime?            @db.Timestamptz(6)
  status             String?              @default("unpublished") @db.VarChar(50)
  isExclusive        Boolean?             @default(false)
  isCommentEnabled   Boolean?             @default(true)
  comments           comments[]
  discussion_threads discussion_threads[]
  podcast            podcast?             @relation(fields: [podcastid], references: [podcastid], onUpdate: NoAction)
  User               User?                @relation(fields: [uploaderid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
  episode_favorites  episode_favorites[]
  listening_history  listening_history[]
  quizzes            quizzes[]
  ratings            ratings[]
  speech_recognition speech_recognition[]
  tags               tag[]
  vocabulary         vocabulary[]
}

model episode_favorites {
  favoriteid   Int       @id @default(autoincrement())
  userid       String?
  episodeid    String?
  favoriteDate DateTime? @default(now()) @db.Timestamptz(6)
  episode      episode?  @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
  User         User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userid, episodeid]) // 防止重复收藏
}

model podcast_favorites {
  favoriteid   Int       @id @default(autoincrement())
  userid       String?
  podcastid    String?
  favoriteDate DateTime? @default(now()) @db.Timestamptz(6)
  podcast      podcast?  @relation(fields: [podcastid], references: [podcastid], onDelete: Cascade, onUpdate: NoAction)
  User         User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)

  @@unique([userid, podcastid]) // 防止重复收藏
}

model tag {
  id        Int       @id @default(autoincrement())
  name      String    @unique @db.VarChar(50) // 唯一名称，防止重复
  createdAt DateTime  @default(now()) @map("created_at")
  // 隐式多对多关联
  podcasts  podcast[]
  episodes  episode[]

  @@map("tags")
}

model learning_paths {
  pathid     Int       @id @default(autoincrement())
  userid     String?
  pathName   String    @db.VarChar(255)
  creationAt DateTime? @default(now()) @db.Timestamptz(6)
  User       User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

/// 听播历史记录模型，用于追踪用户收听剧集的历史
/// 
/// 该模型记录用户对剧集的收听情况，包括收听时间、进度等信息。
/// 支持断点续传功能，允许用户暂停后继续收听，同时确保
/// 每个用户对每集只有一条记录。
/// 
/// 字段说明：
/// - historyid: 历史记录唯一标识符，自动递增
/// - userid:关联的用户ID
/// - episodeid: 关联的剧集ID
/// - listenAt: 开始收听的时间，默认为当前时间
/// - progressSeconds: 已收听的秒数，用于断点续传功能
/// - isFinished: 标识是否已完成收听/// - episode: 关联的剧集对象
/// - User: 关联的用户对象
/// 
/// 约束说明：
/// - 在userid和episodeid上创建复合唯一索引，确保每个用户对每集只有一条记录
model listening_history {
  historyid Int       @id @default(autoincrement())
  userid    String?
  episodeid String?
  listenAt  DateTime? @default(now()) @db.Timestamptz(6)

  // [新增] 精听必须具备的“断点续传”
  progressSeconds Int     @default(0) // 听到第几秒
  isFinished      Boolean @default(false) // 是否听完

  episode episode? @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
  User    User?    @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)

  // 复合唯一索引：确保一个用户对一集只有一条最新的历史记录（或者你可以选择保留多条，看业务逻辑）
  // 建议加上这个以方便 upsert 操作
  @@unique([userid, episodeid])
}

model notifications {
  notificationid   Int       @id @default(autoincrement())
  userid           String?
  notificationText String?
  notificationAt   DateTime? @default(now()) @db.Timestamptz(6)
  isRead           Boolean?  @default(false)
  User             User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

//  测验题
model quizzes {
  // 测验主键ID，自动递增
  quizid        Int      @id @default(autoincrement())
  // 关联的剧集ID，可为空
  episodeid     String?
  // 测验问题文本
  question      String
  // 测验选项，以JSON格式存储，可为空
  options       Json?
  // 正确答案文本
  correctAnswer String   @db.VarChar(255)
  // 与episode表的关联关系
  // 当关联的episode被删除时，级联删除相关的quiz记录
  // 更新操作不执行任何动作
  episode       episode? @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
}

/// This table contains check constraintsand requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ratings {
  ratingid    Int       @id @default(autoincrement())
  userid      String?
  episodeid   String?
  ratingValue Int?
  ratingDate  DateTime? @default(now()) @db.Timestamptz(6)
  episode     episode?  @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
  User        User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

///语音识别结果模型，用于存储用户语音识别的记录和评估
/// 
/// 该模型保存用户语音输入的识别结果及其准确度评分，
/// 并关联到相应的剧集和原文内容，用于语言学习中的发音练习。
/// 
/// 字段说明：
/// - recognitionid: 识别记录唯一标识符，自动递增
/// - userid: 关联的用户ID
/// - episodeid: 关联的剧集ID
/// - speechText: 识别出的用户语音文本
/// - accuracyScore: 语音识别准确度评分
/// - targetText: 对应的原文内容
/// - targetStartTime: 原文内容在音频中的起始时间（秒）
/// - recognitionDate: 识别记录创建时间，默认为当前时间
/// - episode: 关联的剧集对象
/// - User: 关联的用户对象
model speech_recognition {
  recognitionid Int     @id @default(autoincrement())
  userid        String?
  episodeid     String?
  speechText    String?
  accuracyScore Float?

  // [新增] 关联原文内容
  targetText      String? // 原文里的话
  targetStartTime Int? // 原文开始的时间（秒）
  recognitionDate DateTime? @default(now()) @db.Timestamptz(6)
  episode         episode?  @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)
  User            User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model study_groups {
  groupid    Int       @id @default(autoincrement())
  groupName  String    @db.VarChar(255)
  creatorid  String?
  creationAt DateTime? @default(now()) @db.Timestamptz(6)
  User       User?     @relation(fields: [creatorid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model subscriptions {
  subscriptionid   Int       @id @default(autoincrement())
  userid           String?
  subscriptionType String    @db.VarChar(50)
  startDate        DateTime? @default(now()) @db.Timestamptz(6)
  endDate          DateTime? @db.Timestamptz(6)
  User             User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
}

model vocabulary {
  vocabularyid    Int       @id @default(autoincrement())
  userid          String?
  word            String    @db.VarChar(255)
  definition      String?
  contextSentence String?   @db.Text
  translation     String?   @db.Text
  episodeid       String?
  timestamp       Int?
  speakUrl        String?   @db.VarChar(500) // 单词发音链接
  dictUrl         String?   @db.VarChar(500) // 移动端 App 深度链接 (yddict://...)
  webUrl          String?   @db.VarChar(500) // 桌面网页版查看链接 (https://m.youdao.com...)
  mobileUrl       String?   @db.VarChar(500) // 移动端网页版查看链接 (http://mobile.youdao.com...)
  proficiency     Int       @default(0)
  nextReviewAt    DateTime? @default(now()) @db.Timestamptz(6)
  addedDate       DateTime? @default(now()) @db.Timestamptz(6)
  User            User?     @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)
  episode         episode?  @relation(fields: [episodeid], references: [episodeid], onDelete: Cascade, onUpdate: NoAction)

  @@index([userid, episodeid])
}

model captcha {
  id        String   @id @default(cuid())
  code      String
  answer    String
  expiresAt DateTime @db.Timestamptz(3)
  createAt  DateTime @default(now()) @db.Timestamptz(3)
}

model sms_code {
  id       Int      @id @default(autoincrement())
  phone    String   @db.VarChar(15)
  code     String   @db.VarChar(6)
  createAt DateTime @default(now()) @map("created_at") @db.Timestamptz(3)
}

// 电子邮件验证
model verification_code {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

/// 用户每日活动统计表
/// 用于精确追踪每一天的学习时长、活跃状态，支持打卡(Streak)和图表分析
model user_daily_activity {
  id     String   @id @default(cuid())
  userid String
  date   DateTime @db.Date // 仅存储日期 (YYYY-MM-DD 00:00:00)

  // 当日收听时长 (秒) - 精确累加
  listeningSeconds Int @default(0)

  // 当日新学单词数 - 可作为缓存字段，也可通过关联查询实时计算，这里建议缓存以提升查询性能
  wordsLearned Int @default(0)

  // 是否视为“已打卡” (例如收听超过5分钟)
  isActive Boolean @default(false)

  createAt DateTime @default(now()) @db.Timestamptz(6)
  updateAt DateTime @updatedAt @db.Timestamptz(6)

  User User @relation(fields: [userid], references: [userid], onDelete: Cascade, onUpdate: NoAction)

  // 确保每个用户每天只有一条记录
  @@unique([userid, date])
  // 添加索引以便快速查询最近7天/30天的数据
  @@index([userid, date(sort: Desc)])
}
